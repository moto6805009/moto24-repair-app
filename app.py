import streamlit as st
import requests

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
st.set_page_config(page_title="р╕Кр╣Ир╕нр╕Зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓р╕гр╕░р╕Ър╕Ър╣Бр╕ер╕░р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М IT", layout="centered")
st.title("ЁЯЦея╕П р╕Кр╣Ир╕нр╕Зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓р╕гр╕░р╕Ър╕Ър╣Бр╕ер╕░р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М IT")

# р╕Др╣Ир╕▓р╕Др╕Зр╕Чр╕╡р╣И
WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzd67eqgXFH_b82pnFrPsUlfgmPKto1mlp9rGgJUObVUqtx4cc0eDGFcBbbtmz4oMFnJg/exec"  # ЁЯФз р╣Бр╕Бр╣Й URL р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╣Ар╕нр╕З
ADMIN_PASSWORD = "Admin123"

# р╕гр╕▓р╕вр╕Кр╕╖р╣Ир╕нр╕кр╕▓р╕Вр╕▓ (р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Бр╣Йр╣Ар╕Юр╕┤р╣Ир╕б/р╕ер╕Фр╣Др╕Фр╣Й)
branches = [
    "01-р╕кр╕│р╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╣Гр╕лр╕Нр╣И", "02-р╕гр╕░р╣Вр╕Щр╕Ф1", "03-р╕кр╕┤р╕Зр╕лр╕Щр╕Др╕г", "04-р╕кр╕Чр╕┤р╕Зр╕Юр╕гр╕░", "05-р╕гр╕░р╣Вр╕Щр╕Ф2", "06-р╕Ър╣Ир╕нр╕ер╣Йр╕н",
    "07-р╕лр╕▒р╕зр╣Др╕Чр╕г", "08-р╕Кр╕░р╕нр╕зр╕Ф", "09-р╕гр╣Ир╕нр╕Щр╕Юр╕┤р╕Ър╕╣р╕ер╕вр╣М", "10-р╕лр╕▒р╕зр╕Цр╕Щр╕Щ", "11-р╕Ыр╕▓р╕Бр╕Юр╕Щр╕▒р╕З", "12-р╕ер╕▓р╕Щр╕кр╕Бр╕▓",
    "13-р╕Чр╣Ир╕▓р╕ир╕▓р╕ер╕▓", "14-р╕гр╣Ир╕нр╕Щр╕Юр╕┤р╕Ър╕╣р╕ер╕вр╣М24", "15-р╕Ър╣Ир╕нр╕ер╣Йр╕н24", "16-р╕Чр╕╕р╣Ир╕Зр╣Гр╕лр╕Нр╣И24", "17-р╕Ир╕▒р╕Щр╕Фр╕╡",
    "18-р╕лр╕▒р╕зр╣Др╕Чр╕г24", "19-р╕кр╕Хр╕╣р╕е24", "20-р╕Йр╕ер╕╕р╕З24", "21-р╕Чр╣Ир╕▓р╣Бр╕Ю24", "22-р╕ер╕░р╕Зр╕╣24", "23-р╕Кр╕░р╕нр╕зр╕Ф24",
    "24-р╕Щр╕Ър╕Юр╕┤р╕Хр╕│24", "25-р╕Юр╕┤р╕Ыр╕╣р╕Щ24", "26-р╕Ыр╕▓р╕Бр╕Юр╕Щр╕▒р╕З24", "27-р╕Др╕зр╕Щр╕Бр╕▓р╕лр╕ер╕З24", "28-р╕кр╕Чр╕┤р╕Зр╕Юр╕гр╕░24",
    "29-р╕гр╕░р╣Вр╕Щр╕Ф24", "30-р╕кр╕┤р╕Зр╕лр╕Щр╕Др╕г24", "31-р╕Чр╣Ир╕▓р╕ир╕▓р╕ер╕▓24", "32-р╕гр╕▒р╕Хр╕ар╕╣р╕бр╕┤ 24", "33-р╕лр╕▒р╕зр╕Цр╕Щр╕Щ24",
    "34-р╕Др╕╣р╕Вр╕зр╕▓р╕З", "35-р╕Др╕зр╕Щр╕лр╕┤р╕Щ", "36-р╕Др╕зр╕Щр╕лр╕┤р╕Щ24", "37-р╕Ър╣Йр╕▓р╕Щр╕Фр╣Ир╕▓р╕Щ24", "38-р╕Чр╕╕р╣Ир╕Зр╣Гр╕лр╕Нр╣И", "39-р╕Ър╣Йр╕▓р╕Щр╕Фр╣Ир╕▓р╕Щ24"
]

# р╣Ар╕бр╕Щр╕╣
menu = st.sidebar.radio("ЁЯУЛ р╣Ар╕ер╕╖р╕нр╕Бр╣Ар╕бр╕Щр╕╣", ["р╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓", "р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░", "р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щ"])

# р╣Ар╕Кр╕╖р╣Ир╕нр╕б Webhook
def post_json(data):
    try:
        res = requests.post(WEBHOOK_URL, json=data)
        return res.json()
    except:
        return None

def get_json(params=None):
    try:
        res = requests.get(WEBHOOK_URL, params=params)
        return res.json()
    except:
        return None

# ---------- р╕лр╕Щр╣Йр╕▓р╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓ ----------
if menu == "р╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓":
    st.subheader("ЁЯУЭ р╕Кр╣Ир╕нр╕Зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓р╕гр╕░р╕Ър╕Ър╣Бр╕ер╕░р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М IT")

    name = st.text_input("ЁЯСд р╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Бр╕Ир╣Йр╕З")
    branch = st.selectbox("ЁЯПв р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕▓р╕Вр╕▓", branches)
    topic = st.text_area("ЁЯУМ р╕лр╕▒р╕зр╕Вр╣Йр╕н")
    detail = st.text_area("ЁЯЦКя╕П р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б")
    contact = st.text_input("тШОя╕П р╕Кр╣Ир╕нр╕Зр╕Чр╕▓р╕Зр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╕Бр╕ер╕▒р╕Ъ")

    if st.button("тЬЕ р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е"):
        if name and branch and topic:
            payload = {
                "action": "add",
                "name": name,
                "company": branch,
                "problem": topic,
                "reason": detail,
                "contact": contact
            }
            result = post_json(payload)
            if result and result.get("status") == "success":
                st.success(f"ЁЯОЙ р╣Бр╕Ир╣Йр╕Зр╕Ыр╕▒р╕Нр╕лр╕▓р╕кр╕│р╣Ар╕гр╣Зр╕И! р╕гр╕лр╕▒р╕кр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Др╕╖р╕н **{result['id']}**")
            else:
                st.error("тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣И")
        else:
            st.warning("тЪая╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╣Йр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ")

# ---------- р╕лр╕Щр╣Йр╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░ ----------
elif menu == "р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░":
    st.subheader("ЁЯФО р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕Ыр╕▒р╕Нр╕лр╕▓")
    code = st.text_input("р╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕З (р╣Ар╕Кр╣Ир╕Щ Moto00001)")
    if st.button("ЁЯУе р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ"):
        result = get_json(params={"action": "check", "id": code})
        if result and result.get("id"):
            st.success("тЬЕ р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕Зр╕гр╕лр╕▒р╕кр╕Щр╕╡р╣Йр╣Бр╕ер╣Йр╕з")
            st.info(
                f"ЁЯз╛ р╕гр╕лр╕▒р╕к: {result['id']}\n"
                f"ЁЯСд р╕Ьр╕╣р╣Йр╣Бр╕Ир╣Йр╕З: {result['name']}\n"
                f"ЁЯПв р╕кр╕▓р╕Вр╕▓: {result['company']}\n"
                f"ЁЯУМ р╕лр╕▒р╕зр╕Вр╣Йр╕н: {result['problem']}\n"
                f"ЁЯЦКя╕П р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф: {result['reason']}\n"
                f"тШОя╕П р╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╕Бр╕ер╕▒р╕Ъ: {result['contact']}\n"
                f"ЁЯХТ р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕Ир╣Йр╕З: {result['date']}\n"
                f"ЁЯУК р╕кр╕Цр╕▓р╕Щр╕░: {result['status']}"
            )
        else:
            st.warning("тЭЧ р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕лр╕▒р╕кр╕Щр╕╡р╣Йр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ")

# ---------- р╕лр╕Щр╣Йр╕▓р╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ ----------
elif menu == "р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щ":
    st.subheader("ЁЯФР р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╣Бр╕нр╕Фр╕бр╕┤р╕Щ")
    password = st.text_input("р╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ", type="password")
    if password == ADMIN_PASSWORD:
        st.success("тЬЕ р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И")
        data = get_json(params={"action": "all"})
        if data:
            for row in reversed(data):
                st.info(
                    f"{row['id']} | {row['name']} | р╕кр╕▓р╕Вр╕▓: {row['company']} | р╕кр╕Цр╕▓р╕Щр╕░: {row['status']}"
                )
            st.markdown("---")
            st.subheader("ЁЯЫа р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕З")
            rid = st.text_input("р╕гр╕лр╕▒р╕кр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕З")
            newstatus = st.selectbox("р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕Цр╕▓р╕Щр╕░р╣Гр╕лр╕бр╣И", ["р╕гр╕нр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г", "р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г", "р╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з", "р╕вр╕Бр╣Ар╕ер╕┤р╕Б"])
            if st.button("ЁЯУд р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░"):
                result = post_json({"action": "update", "id": rid, "status": newstatus})
                if result and result.get("status") == "updated":
                    st.success("тЬЕ р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з")
                else:
                    st.error("тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Др╕Фр╣Й р╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕Юр╕Ър╕гр╕лр╕▒р╕к")
    elif password:
        st.error("тЭМ р╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З")

р╕Юр╕нр╕Бр╕Фр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е р╕бр╕▒р╕Щр╕Вр╕╢р╣Йр╕Щр╕зр╣Ир╕▓ тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣И
